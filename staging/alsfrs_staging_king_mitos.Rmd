---
title: "Estimate King's and MiTos Stages with ALSFRS revised scores"
output: html_notebook
---

## Objectives
to estimate clinical stage, i.e., king's stage and mitos stage, using alsfrs  scores

## Reference
Rubika Balendra (2014) Estimating clinical stage of amyotrophic lateral sclerosis from the ALS Functional Rating Scale, Amyotrophic Lateral Sclerosis and Frontotemporal Degeneration, 15:3-4, 279-284, DOI: 10.3109/21678421.2014.897357   
Chiò A, Hammond ER, Mora G, et al. J Neurol Neurosurg Psychiatry 2015;86:38–44.  

```{r}
library(tidyverse)
```


```{r}
# read-in ALSFRS_rev data
alsfrs <- read.csv("data/ALSFRS_rev.csv")
names(alsfrs) = tolower(names(alsfrs))
```


## King's staging   
gastrostomy를 받은 환자나 NIV를 사용하는 환자는 stage4로 따로 분류하고,  
stage 4가 아닌 환자 중 bulbar, 상지, 하지 중 involve 된 개수로 stage 1~3 부여 

```{r}
stage_king = alsfrs %>%
  mutate(bulbar_involved = ifelse(bulbar < 12, 1, 0), 
         upperlimb_involved = ifelse((q4_handwriting + q5_cutting) < 8, 1, 0), 
         lowerlimb_involved = ifelse(q8_walking < 4, 1, 0)) %>%
  mutate(king = bulbar_involved + upperlimb_involved + lowerlimb_involved) %>%
  mutate(king = case_when(
    (gastrostomy == T)|(r1_dyspnea == 0|r3_respiratory_insufficiency < 4) ~ 4, 
                          TRUE ~ king)) %>% 
  select(subjectid, feature_delta, king)
```

```{r}
stage_king %>%
  count(king) %>%
  mutate(prop = round(n/sum(n)*100, 2))
```

stage = 0 in 119 observations, why?  
- trunk (Q6, Q7) or leg involved in climbing stairs (Q9) but not in walking (Q8) 
- respiration involved (Q10) to such an extent that does not require NIV   

```{r}
# replace stage 0 with stage 1 
stage_king$king = ifelse(stage_king$king == 0, 1, stage_king$king)
```

```{r}
stage_king = within(stage_king, {
  king = factor(king)
  subjectid = as.character(subjectid)
})
summary(stage_king)
```

## mitos staging

```{r}
stage_mitos = alsfrs %>%
  mutate(swallowing = ifelse(q3_swallowing <= 1, 1, 0)) %>%
  mutate(breathing = ifelse(r1_dyspnea <= 1|r3_respiratory_insufficiency <= 2, 1, 0)) %>%
  mutate(communicating = ifelse(q1_speech <= 1 & 
                                  q4_handwriting <=1, 1, 0)) %>%
  mutate(movement = ifelse(q6_dressing_and_hygiene <= 1|
                             q8_walking <=1, 1, 0)) %>%
  mutate(mitos = swallowing + breathing + communicating + movement) %>%
  select(subjectid, feature_delta, mitos)
```


```{r}
stage_mitos %>%
  count(mitos) %>%
  mutate(prop = round(n/sum(n)*100, 2))
```

```{r}
stage_mitos = within(stage_mitos, {
  subjectid = as.character(subjectid)
  mitos = factor(mitos)
})
summary(stage_mitos)
```


```{r}
# merge king and mitos stages 
stage_merged = stage_king %>%
  inner_join(stage_mitos, by = c("subjectid", "feature_delta"))
```


## merge with survival data 
death = stage 5 in Mitos and King's staging system  

```{r}
surv = read_csv('data/survival.csv')
names(surv) = tolower(names(surv))
```

```{r}
deceased = surv %>%
  filter(status == 1) %>%
  filter(subjectid %in% stage_merged$subjectid)
```

```{r}
deceased = deceased %>%
  rename(feature_delta = time_event) %>%
  mutate(king = 5, mitos = 5) %>%
  mutate(subjectid = as.character(subjectid), 
         king = factor(king),
         mitos = factor(mitos)) %>%
  select(subjectid, feature_delta, king, mitos)
```



```{r}
stage_final = bind_rows(stage_merged, deceased)
summary(stage_final)
```

In some patients, the time of death coincided with the time of alsfrs recording.  
```{r}
stage_final %>%
  group_by(subjectid, feature_delta) %>%
  count() %>%
  filter(n > 1) -> temp
temp$subjectid -> ids 
temp$feature_delta -> deltas
```


```{r}
stage_final %>%
  filter(subjectid %in% ids) %>%
  filter(feature_delta %in% deltas)
```

```{r}
temp = stage_final %>%
  filter(subjectid %in% ids) %>%
  filter(feature_delta %in% deltas) %>%
  filter(!(king == 5))
```

```{r}
stage = stage_final %>%
  anti_join(temp, by=c("subjectid","feature_delta","king","mitos"))
```


```{r}
write_csv(stage, "data/stage_king_mitos.csv")
```

*The End*   


